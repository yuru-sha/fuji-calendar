# 要件定義書

## 概要

ダイヤモンド富士とパール富士の撮影に最適な日時と場所を表示するカレンダーアプリケーション。写真愛好家が効率的に撮影計画を立てられるよう、天体の位置計算に基づいた正確な情報を提供する。

## 要件

### 要件1

**ユーザーストーリー:** 写真愛好家として、ダイヤモンド富士が見える日時と場所を知りたい。撮影計画を効率的に立てるため。

#### 受入基準

1. WHEN ユーザーがカレンダーを開く THEN システムは今月のダイヤモンド富士の発生日を表示する SHALL
2. WHEN ユーザーが特定の日付をクリックする THEN システムはその日のダイヤモンド富士の詳細情報を表示する SHALL
3. WHEN ダイヤモンド富士の詳細情報を表示する THEN システムは「【昇るダイヤモンド富士】4時33分頃 奈良県・大台ヶ原(日出ヶ岳)付近 地図を確認」の形式で表示する SHALL
4. WHEN ユーザーが「地図を確認」リンクをクリックする THEN システムは撮影地点と富士山の方向を示す地図を表示する SHALL
5. IF ダイヤモンド富士が発生しない日の場合 THEN システムは「この日はダイヤモンド富士は発生しません」と表示する SHALL

### 要件2

**ユーザーストーリー:** 写真愛好家として、パール富士が見える日時と場所を知りたい。月の撮影も計画に含めるため。

#### 受入基準

1. WHEN ユーザーがカレンダーを開く THEN システムは今月のパール富士の発生日を表示する SHALL
2. WHEN ユーザーが特定の日付をクリックする THEN システムはその日のパール富士の詳細情報を表示する SHALL
3. WHEN パール富士の詳細情報を表示する THEN システムは「【沈むパール富士】19時15分頃 山梨県・河口湖畔 地図を確認」の形式で表示する SHALL
4. WHEN ユーザーが「地図を確認」リンクをクリックする THEN システムは撮影地点と富士山・月の方向を示す地図を表示する SHALL
5. WHEN パール富士とダイヤモンド富士が同日に発生する THEN システムは両方の情報を区別して表示する SHALL

### 要件3

**ユーザーストーリー:** ユーザーとして、月や年を変更してカレンダーを閲覧したい。長期的な撮影計画を立てるため。

#### 受入基準

1. WHEN ユーザーが月の切り替えボタンをクリックする THEN システムは選択された月のカレンダーを表示する SHALL
2. WHEN ユーザーが年を変更する THEN システムはその年の天体計算に基づいた正確な情報を表示する SHALL
3. WHEN 過去の日付を表示する THEN システムは過去のデータも正確に計算して表示する SHALL

### 要件4

**ユーザーストーリー:** ユーザーとして、撮影地点の詳細情報を知りたい。実際の撮影場所を特定するため。

#### 受入基準

1. WHEN ユーザーが撮影地点をクリックする THEN システムは地図上での位置、アクセス方法、撮影のコツを表示する SHALL
2. WHEN 複数の撮影地点がある場合 THEN システムは距離や難易度でソートして表示する SHALL
3. IF 撮影地点が立入禁止や危険な場合 THEN システムは警告メッセージを表示する SHALL



### 要件5

**ユーザーストーリー:** ユーザーとして、お気に入りの日付を保存したい。重要な撮影日を忘れないため。

#### 受入基準

1. WHEN ユーザーが日付をお気に入りに追加する THEN システムはその日付を保存する SHALL
2. WHEN ユーザーがお気に入り一覧を表示する THEN システムは保存された日付を時系列で表示する SHALL
3. WHEN お気に入りの日付が近づく THEN システムは通知機能を提供する SHALL

### 要件6

**ユーザーストーリー:** 管理者として、撮影地点を登録・管理したい。正確で最新の撮影地点情報を提供するため。

#### 受入基準

1. WHEN 管理者が管理画面にアクセスする THEN システムは認証画面を表示する SHALL
2. WHEN 管理者が正しい認証情報を入力する THEN システムは撮影地点管理画面を表示する SHALL
3. WHEN 管理者が間違った認証情報を入力する THEN システムは「認証に失敗しました」と表示する SHALL
4. WHEN 管理者が地図上の地点をクリックする THEN システムは緯度・経度・標高を自動取得して入力フォームに設定する SHALL
5. WHEN 管理者が撮影地点情報を入力して保存する THEN システムは新しい撮影地点をデータベースに登録する SHALL
6. WHEN 管理者が既存の撮影地点を編集する THEN システムは変更内容を保存する SHALL
7. WHEN 認証されていないユーザーが管理画面にアクセスしようとする THEN システムはログイン画面にリダイレクトする SHALL

### 要件7

**ユーザーストーリー:** 一般ユーザーとして、新しい撮影地点をリクエストしたい。知っている良い撮影地点を共有するため。

#### 受入基準

1. WHEN ユーザーが撮影地点リクエストフォームを開く THEN システムはキャプチャ付きのリクエスト送信フォームを表示する SHALL
2. WHEN ユーザーがキャプチャを正しく入力してリクエストを送信する THEN システムはリクエスト内容を管理者に通知する SHALL
3. WHEN ユーザーがキャプチャを間違って入力する THEN システムは「キャプチャが正しくありません」と表示する SHALL
4. WHEN ユーザーが連続してリクエストを送信しようとする THEN システムは一定時間内の重複送信を防止する SHALL
5. IF ユーザーが24時間以内にリクエストを送信済みの場合 THEN システムは「24時間以内に再送信はできません」と表示する SHALL

### 要件8

**ユーザーストーリー:** システム管理者として、撮影地点データを永続化したい。アプリケーション再起動後もデータを保持するため。

#### 受入基準

1. WHEN システムが起動する THEN システムはSQLiteデータベースファイルから撮影地点データを読み込む SHALL
2. WHEN 撮影地点が追加・更新・削除される THEN システムはSQLiteデータベースに変更を永続化する SHALL
3. WHEN データベースファイルが存在しない場合 THEN システムは新しいデータベースファイルを作成する SHALL
4. WHEN データベース操作でエラーが発生した場合 THEN システムは適切なエラーメッセージを表示する SHALL

### 要件9

**ユーザーストーリー:** システム管理者として、セキュリティを確保したい。不正アクセスやデータ改ざんを防ぐため。

#### 受入基準

1. WHEN 管理者がログインを試行する THEN システムはbcryptを使用してパスワードをハッシュ化して検証する SHALL
2. WHEN ログイン試行が連続で失敗する THEN システムは一定時間アカウントをロックする SHALL
3. WHEN 管理者セッションが一定時間非アクティブになる THEN システムは自動的にログアウトする SHALL
4. WHEN SQLインジェクション攻撃が試行される THEN システムはパラメータ化クエリで防御する SHALL
5. WHEN XSS攻撃が試行される THEN システムは入力値をサニタイズして防御する SHALL
6. WHEN CSRF攻撃が試行される THEN システムはCSRFトークンで防御する SHALL
7. WHEN 管理画面にアクセスする THEN システムはHTTPS通信を強制する SHALL

### 要件11

**ユーザーストーリー:** ユーザーとして、日本の撮影地点に適した時刻表示を見たい。現地時間で撮影計画を立てるため。

#### 受入基準

1. WHEN システムが時刻を表示する THEN システムは全ての時刻をJST（日本標準時）で表示する SHALL
2. WHEN ダイヤモンド富士・パール富士の時刻を計算する THEN システムはJSTタイムゾーンで計算する SHALL
3. WHEN 時刻を表示する THEN システムは「4時33分」「19時15分」の形式で24時間表記を使用する SHALL
4. WHEN データベースに時刻を保存する THEN システムはJSTで保存する SHALL