# 実装計画

- [x] 1. プロジェクト構造とコア設定の作成
  - TypeScriptプロジェクトの初期化とディレクトリ構造の作成
  - package.jsonの設定とTypeScript設定ファイルの作成
  - フロントエンドとバックエンドの基本的なエントリーポイントを作成
  - _要件: 9.1, 9.3_

- [x] 2. データベーススキーマとモデルの実装
  - SQLiteデータベースの初期化スクリプトを作成
  - locations、admins、location_requests、request_limitsテーブルを作成
  - TypeScript型定義とデータベース操作用のモデルクラスを実装
  - _要件: 9.1, 9.2, 7.5, 8.1_

- [x] 3. 天体計算エンジンの実装
  - SunCalcライブラリの統合とカスタム計算ロジックの実装
  - 富士山への方位角計算機能を実装
  - ダイヤモンド富士とパール富士の発生日時計算機能を実装
  - 天体計算の単体テストを作成
  - _要件: 1.2, 1.3, 2.2, 2.3_

- [x] 4. 認証システムの実装
  - bcryptを使用したパスワードハッシュ化機能を実装
  - JWT認証ミドルウェアとログイン/ログアウト機能を実装
  - セッション管理と自動ログアウト機能を実装
  - ブルートフォース攻撃対策（アカウントロック機能）を実装
  - _要件: 7.1, 7.2, 7.3, 7.7, 10.1, 10.2, 10.3_

- [x] 5. セキュリティミドルウェアの実装
  - CSRF保護、XSS対策、SQLインジェクション対策を実装
  - レート制限とHTTPS強制機能を実装
  - セキュリティヘッダーの設定を実装
  - _要件: 10.4, 10.5, 10.6, 10.7_

- [x] 6. バックエンドAPIエンドポイントの実装
  - カレンダーデータ取得API（GET /api/calendar/:year/:month）を実装
  - 日付別イベント取得API（GET /api/events/:date）を実装
  - 撮影地点一覧取得API（GET /api/locations）を実装
  - APIエンドポイントの単体テストを作成
  - _要件: 1.1, 1.2, 2.1, 2.2, 4.1_

- [x] 7. 管理者用APIエンドポイントの実装
  - 撮影地点作成API（POST /api/admin/locations）を実装
  - 撮影地点更新・削除APIを実装
  - 地図クリック時の座標取得機能を実装（デモ版）
  - リバースジオコーディング機能を実装
  - 管理者認証が必要なエンドポイントの保護を実装（未完了）
  - _要件: 7.4, 7.5, 7.6_

- [ ] 8. 撮影地点リクエスト機能の実装
  - キャプチャ機能付きリクエスト送信API（POST /api/location-requests）を実装
  - 連続投稿防止機能（24時間制限）を実装
  - 管理者への通知機能を実装
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 9. フロントエンド基盤の実装
  - Reactプロジェクトの初期化とルーティング設定
  - CSS ModulesとLeaflet地図コンポーネントの基本設定
  - 共通UIコンポーネント（ボタン、フォーム、モーダル）を作成
  - _要件: 1.1, 4.1_

- [x] 10. カレンダーコンポーネントの実装
  - 月間カレンダー表示コンポーネントを実装
  - ダイヤモンド富士・パール富士イベントの表示機能を実装（カスタム富士山アイコン対応）
  - 月・年の切り替え機能を実装
  - 日付クリック時の詳細表示機能を実装
  - _要件: 1.1, 1.2, 2.1, 2.2, 3.1, 3.2_

- [x] 11. 日付詳細表示コンポーネントの実装
  - 選択日のダイヤモンド富士・パール富士詳細情報を表示
  - 「【昇るダイヤモンド富士】4時33分頃 奈良県・大台ヶ原(日出ヶ岳)付近 地図を確認」形式での表示
  - 地図確認リンクの実装
  - Google Maps連携機能も追加実装
  - 天気情報の表示機能を実装
  - _要件: 1.3, 1.4, 2.3, 2.4, 5.1, 5.2_

- [x] 12. 地図表示コンポーネントの実装
  - Leafletを使用した地図表示機能を実装（国土地理院淡色タイル使用）
  - 撮影地点と富士山の位置表示機能を実装
  - 撮影方向（太陽・月の方向）の表示機能を実装
  - 撮影地点詳細情報（アクセス方法、注意事項）の表示機能を実装
  - カスタムマーカーとポップアップ機能を実装
  - _要件: 1.4, 2.4, 4.1, 4.2, 4.3_

- [ ] 13. お気に入り機能の実装
  - 日付のお気に入り追加・削除機能を実装
  - お気に入り一覧表示機能を実装
  - ローカルストレージを使用したデータ永続化を実装
  - _要件: 6.1, 6.2_

- [x] 14. 管理画面の実装
  - 管理者ログイン画面を実装（未完了）
  - 撮影地点管理画面（一覧・作成・編集・削除）を実装
  - 地図クリックによる座標自動入力機能を実装（デモ版）
  - 撮影地点リクエスト管理画面を実装（未完了）
  - レスポンシブデザインとダークモード対応を実装
  - _要件: 7.1, 7.2, 7.4, 7.5, 7.6_

- [ ] 15. 撮影地点リクエスト画面の実装
  - キャプチャ付きリクエスト送信フォームを実装
  - フォームバリデーションとエラーハンドリングを実装
  - 送信制限（24時間制限）の表示機能を実装
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 16. エラーハンドリングとローディング状態の実装
  - API呼び出し時のローディング表示を実装
  - エラー状態の適切な表示とユーザーフレンドリーなメッセージを実装
  - ネットワークエラーやタイムアウトの処理を実装
  - _要件: 9.4_

- [ ] 17. 統合テストの実装
  - カレンダー表示から詳細表示までのE2Eテストを作成
  - 管理画面での撮影地点登録フローのテストを作成
  - 認証フローの統合テストを作成
  - _要件: 全要件の統合テスト_

- [ ] 18. パフォーマンス最適化とデプロイ準備
  - フロントエンドのビルド最適化とコード分割を実装
  - バックエンドのレスポンス最適化とキャッシュ機能を実装
  - 本番環境用の設定ファイルとDockerfileを作成
  - _要件: システム全体の最適化_

## 追加実装された改善機能

- [x] **UI/UX改善**
  - モーダル表示からカレンダー下表示への変更
  - スクロールバー非表示化
  - コンテナ幅制限削除とレイアウト最適化
  - EventDetail表示エリアの幅拡大と高さ制限削除

- [x] **地図機能強化**
  - 国土地理院淡色タイル採用
  - Google Maps連携機能（「Google Mapsで開く」ボタン）
  - マーカー表示問題の修正とカスタムアイコン実装

- [x] **カレンダーアイコン改善**
  - ダイヤモンド富士・パール富士の視覚的表現向上
  - 💎🌙 → 🗻☀️🗻🌙 のカスタムアイコンに変更

- [x] **管理機能の実装**
  - AdminController.ts: 撮影地点のCRUD操作API
  - AdminPage.tsx: 撮影地点管理フォーム（作成・編集・削除）
  - AdminPage.module.css: レスポンシブデザインとダークモード対応
  - バリデーション機能とエラーハンドリング
  - 座標自動生成機能（デモ版）
  - リバースジオコーディング機能（簡易版）

## 最新の実装・修正状況 (2025年版)

- [x] **高精度天体計算への移行 (v0.1.0)**
  - SunCalc → Astronomy Engine (NASA JPL準拠) へ完全移行
  - AstronomicalCalculatorAstronomyEngine.ts: 高精度太陽・月位置計算
  - 2段階最適化検索アルゴリズム（粗い検索→精密検索）
  - 日本の気象条件を考慮した大気屈折補正
  - 距離別方位角許容範囲の観測データベース最適化

- [x] **データベース最適化**
  - 事前計算値の実装（fuji_azimuth, fuji_elevation, fuji_distance）
  - fix-location-data.jsスクリプトによる既存データの修正
  - NULL値問題の解決とパフォーマンス向上

- [x] **時刻処理システムの統一**
  - JST基準での時刻処理統一化
  - timeUtils.ts: UTC/JST変換とフォーマット機能
  - カレンダー表示の1日ズレ問題修正
  - 月またぎ日付のアイコン表示問題修正

- [x] **パール富士計算の改善**
  - 月の出入り時刻前後±30分間の詳細検索実装
  - 2分刻みでの精密アライメントチェック
  - パール富士専用許容範囲設定（ダイヤモンド富士の2倍）
  - 海ほたるPAでのパール富士検出成功

- [x] **構造化ログシステム導入**
  - Pino: 高性能構造化ログシステム（5-10倍の性能向上）
  - logger.ts: コンポーネント別・天体計算専用ログ
  - logging.ts: HTTP リクエスト追跡とパフォーマンス監視
  - 本番対応ログローテーションとファイル出力

- [x] **カレンダーサービス拡張**
  - CalendarService.ts: 月間カレンダー表示範囲の拡張
  - 表示カレンダー全体（42日分）の計算対応
  - グループ化処理のJST統一とタイムゾーン問題修正

- [x] **プロジェクト設定更新**
  - package.json: バージョン0.1.0への更新
  - CLAUDE.md: 開発ガイドラインと技術的制約の文書化
  - Astronomy Engineライブラリの依存関係追加

- [x] **包括的ドキュメント整備**
  - README.md: バージョン0.1.0機能とAstronomy Engine対応
  - docs/ ディレクトリ構造の完全構築:
    - api.md: 完全なRESTful APIリファレンス
    - installation.md: Docker・ローカル環境詳細セットアップ
    - architecture.md: システム設計と技術アーキテクチャ
    - astronomical-calculations.md: 天体計算の詳細実装
    - troubleshooting.md: トラブルシューティングと診断
    - debug.md: 開発時デバッグ手順
    - performance-analysis.md: パフォーマンス分析と改善提案
    - astronomy-engine-analysis.md: 時刻処理分析結果
    - queue-system.md: BullMQキューシステムガイド

- [x] **バグ修正とシステム安定化**
  - データベース接続エラー「イベントデータの読み込みに失敗しました」の解決
  - カレンダーアイコン1日ズレ問題の根本修正
  - 月またぎ日付表示問題の解決
  - パール富士検出漏れ問題の修正

- [x] **開発・運用体制強化**
  - Git履歴の整理とコミット品質向上
  - 技術文書の体系化とメンテナンス性向上
  - デバッグツールと監視機能の充実