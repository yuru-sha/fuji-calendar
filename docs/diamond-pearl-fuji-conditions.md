# ダイヤモンド富士・パール富士の定義と検出システム

**バージョン 0.3.0** - モノレポ構成・高性能版

## 概要

富士山頂に太陽や月が重なる美しい自然現象であるダイヤモンド富士とパール富士について、その物理的定義、観測条件、高精度検出アルゴリズムを詳細に解説します。

## 基本定義

### ダイヤモンド富士（Diamond Fuji）
**定義**: 太陽が富士山頂に重なり、まるでダイヤモンドのように輝く現象
- **物理的条件**: 撮影地から見た太陽の方位角 = 撮影地から見た富士山の方位角
- **高度条件**: 太陽の位置が富士山頂の仰角と一致（±許容誤差内）
- **光学効果**: 太陽光が山頂シルエットと重なることで生成される光芒現象

### パール富士（Pearl Fuji）
**定義**: 月が富士山頂に重なり、真珠のように美しく輝く現象
- **物理的条件**: 撮影地から見た月の方位角 = 撮影地から見た富士山の方位角
- **高度条件**: 月の位置が富士山頂の仰角と一致（±許容誤差内）
- **月相条件**: 月の照度率10%以上（視認性確保のため）

## 富士山基準座標

```typescript
export const FUJI_COORDINATES = {
  latitude: 35.3605556,   // 35°21'38" 北緯（剣ヶ峰）
  longitude: 138.7275,    // 138°43'39" 東経（剣ヶ峰）
  elevation: 3776         // 標高（メートル）剣ヶ峰最高地点
} as const;
```

## 検出アルゴリズム

### 基本パラメータ

#### 許容誤差設定
```typescript
private readonly AZIMUTH_TOLERANCE = 1.5;   // 方位角許容誤差（度）
private readonly ELEVATION_TOLERANCE = 0.5; // 高度許容誤差（度）  
private readonly MIN_ELEVATION = -2.0;      // 最低高度（大気屈折考慮）
private readonly MAX_ELEVATION = 10.0;      // 最高高度制限
private readonly SEARCH_INTERVAL = 30;      // 検索間隔（秒）
```

#### 天体角直径（天文学的標準値）
```typescript
private readonly SUN_ANGULAR_DIAMETER = 0.533;  // 太陽：約32分角
private readonly MOON_ANGULAR_DIAMETER = 0.518; // 月：約31分角（平均）
```

### ダイヤモンド富士検出アルゴリズム

#### 1. 検索時間帯
- **日の出**: 04:00-12:00（早朝から正午まで）
- **日の入**: 14:00-20:00（午後から夕方まで）
- **検索間隔**: 30秒刻みで精密検索

#### 2. 太陽位置パターン
撮影距離に応じて最適なパターンを自動選択：

```typescript
// 近距離向け：太陽上部が山頂
targetElevation = baseTargetElevation - SUN_ANGULAR_DIAMETER / 2

// 標準：太陽中心が山頂  
targetElevation = baseTargetElevation

// 遠距離向け：太陽下部が山頂
targetElevation = baseTargetElevation + SUN_ANGULAR_DIAMETER / 2
```

#### 3. 方位角条件
```typescript
azimuthDifference = |太陽方位角 - 富士山方位角|
条件: azimuthDifference ≤ 1.5度
```

### パール富士検出アルゴリズム

#### 1. 検索時間帯
- **月の出**: 18:00-06:00+1日（夜間から早朝）
- **月の入**: 00:00-12:00（深夜から正午）
- **検索間隔**: 30秒刻みで精密検索

#### 2. 月位置パターン
基本的に月の下部が山頂に来る条件：

```typescript
// パール富士：月下部が山頂
targetElevation = baseTargetElevation + MOON_ANGULAR_DIAMETER / 2
```

#### 3. 月相条件
```typescript
moonIllumination ≥ 0.1  // 照度率10%以上で視認可能
```

## 精度評価システム

### 精度レベル判定
```typescript
private getAccuracyLevel(azimuthDiff: number, elevationDiff: number) {
  if (azimuthDiff ≤ 0.1 && elevationDiff ≤ 0.1) return 'perfect';
  if (azimuthDiff ≤ 0.5 && elevationDiff ≤ 0.2) return 'excellent'; 
  if (azimuthDiff ≤ 1.0 && elevationDiff ≤ 0.3) return 'good';
  return 'fair';
}
```

### 品質指標
- **Perfect**: 方位角差≤0.1度、高度差≤0.1度
- **Excellent**: 方位角差≤0.5度、高度差≤0.2度
- **Good**: 方位角差≤1.0度、高度差≤0.3度
- **Fair**: 上記未満の許容範囲内

## 観測条件詳細

### ダイヤモンド富士

#### 時期的条件
- **主要シーズン**: 10月～2月（太陽南中高度が低い時期）
- **理由**: 太陽軌道が南寄りで富士山方向を通過しやすい

#### 地理的条件
- **西側地域**: 日の出時のダイヤモンド富士（方位角70-110度）
- **東側地域**: 日没時のダイヤモンド富士（方位角250-280度）
- **観測範囲**: 山頂から南北35度以内
- **距離制限**: 300km超では大気の影響で観測困難

#### 時刻条件
```
昇るダイヤモンド富士: 04:00-09:59
沈むダイヤモンド富士: 14:00-19:59
```

### パール富士

#### 時期的条件
- **主要シーズン**: 3月～9月（月軌道が北寄りの時期）
- **最適期**: 満月前後±2日間
- **決定要因**: 月の軌道と満月タイミングの複合条件

#### 地理的条件
- **西側地域**: 月の出時のパール富士
- **東側地域**: 月の入り時のパール富士  
- **方位角制限**: 特になし（月は約29.5日周期で全方位通過）
- **距離制限**: 300km超では観測困難

#### 月相条件
- **最適**: 満月（照度率100%）
- **良好**: 満月前後（照度率80%以上）
- **最低**: 照度率10%以上（視認限界）

## 観測可能性の物理的制約

### 大気条件
1. **大気屈折**: 地平線近くで光が曲がる効果（約0.5度）
2. **大気吸収**: 距離に応じた光量減衰
3. **大気揺らぎ**: 長距離観測時の像の歪み

### 地球曲率の影響
```
見かけの低下 = 距離² / (2 × 地球半径)
```
- **100km**: 約0.8m低下
- **200km**: 約3.1m低下
- **300km**: 約7.0m低下（限界距離）

### 光学的制約
1. **太陽**: 高輝度のため機材への配慮が必要
2. **月**: 低輝度のため長時間露光が有効
3. **コントラスト**: 背景の明度差が視認性に影響

## 検出システムの技術仕様

### 計算精度
- **方位角精度**: ±0.001度（Astronomy Engine準拠）
- **高度精度**: ±0.001度（大気屈折補正込み）
- **時刻精度**: ±30秒（実用十分精度）

### パフォーマンス
- **単一地点・単日**: 約50-100ms
- **100地点・月間**: 約10-30秒
- **メモリ使用量**: 地点あたり約1KB

### データベース保存
```sql
-- イベントデータ構造
CREATE TABLE location_fuji_events (
  id SERIAL PRIMARY KEY,
  location_id INTEGER NOT NULL,
  event_date DATE NOT NULL,
  event_time TIMESTAMP NOT NULL,
  event_type VARCHAR(20) NOT NULL,  -- 'diamond_sunrise', 'pearl_moonset' 等
  azimuth REAL NOT NULL,           -- 天体方位角
  altitude REAL NOT NULL,          -- 天体高度
  accuracy VARCHAR(10)             -- 'excellent', 'good', 'fair'
);
```

## 観測成功の要因分析

### 成功率向上要因
1. **正確な時刻予測**: ±30秒以内の精度
2. **方位角事前確認**: 撮影地からの富士山方向
3. **天候条件**: 晴天率80%以上の日選択
4. **機材準備**: 適切なレンズ選択（焦点距離）

### 失敗要因
1. **雲量**: 雲による遮蔽（最大失敗要因）
2. **大気条件**: 霞、霧による視認性低下
3. **計算誤差**: 稀な天体軌道の特異点
4. **地形障害**: 中間の山や建物による遮蔽

## 撮影技術的考慮事項

### カメラ設定推奨値

#### ダイヤモンド富士
- **焦点距離**: 400-800mm（距離により調整）
- **絞り**: F8-F11（光芒効果を得るため）
- **ISO**: 100-400（ノイズ抑制）
- **シャッター**: 1/125-1/500秒

#### パール富士  
- **焦点距離**: 400-800mm
- **絞り**: F5.6-F8（光量確保）
- **ISO**: 800-3200（月明度に応じて）
- **シャッター**: 1/60-1/250秒

### 構図的考慮
- **画角**: 富士山全体が収まる広角も併用
- **水平**: 地平線の傾き補正
- **前景**: 湖面、建物等の前景要素活用

## デバッグ・検証機能

### ログ出力例
```javascript
{
  locationName: "房総半島・富津岬付近",
  celestialBody: "sun",
  subType: "sunrise", 
  time: "06:42:30",
  celestialAzimuth: "108.245",
  targetAzimuth: "108.180",
  azimuthDiff: "0.065",
  celestialElevation: "2.246",
  targetElevation: "2.250", 
  elevationDiff: "0.004",
  pattern: "center",
  accuracy: "perfect"
}
```

### 検証ツール
- **scripts/debug-diamond-fuji.js**: ダイヤモンド富士の詳細計算確認
- **scripts/debug-pearl-fuji.js**: パール富士の計算プロセス確認
- **scripts/verify-accuracy.js**: 実測値との精度比較

## 希少性と価値

### ダイヤモンド富士
- **年間機会**: 地点により20-40回程度
- **成功率**: 天候条件込みで約20-30%
- **撮影難易度**: 中程度（時刻予測精度が重要）

### パール富士
- **年間機会**: 地点により5-15回程度（月相条件のため）
- **成功率**: 天候条件込みで約15-25%
- **撮影難易度**: 高（月相・軌道・天候の三重条件）

## 関連ドキュメント

- [富士山頂仰角計算](./fuji-elevation-calculation.md)
- [天体計算システム](./astronomical-calculations.md)
- [パフォーマンス分析](./performance-analysis.md)

## 更新履歴

### 2025年7月
- **v2.0**: 高精度検出アルゴリズムの詳細仕様を追加
- **精度システム**: 4段階精度評価システムの導入
- **パターン最適化**: 距離に応じた太陽位置パターンの自動選択
- **データベース統合**: 検出結果の自動保存・管理システム
- **ログ強化**: 詳細なデバッグ情報とトレーサビリティの向上

---

**重要**: このドキュメントは、ダイヤモンド富士・パール富士の科学的定義から実装レベルの技術仕様まで、システムの核心となる知識を包含しています。アルゴリズムの変更や精度調整を行う際は、必ずこの定義に基づいて実施してください。